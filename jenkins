pipeline {
    agent any

    environment {
        // Set environment variables for AWS credentials if required
        AWS_ACCESS_KEY_ID = credentials('aws-access-key-id')
        AWS_SECRET_ACCESS_KEY = credentials('aws-secret-access-key')
        AWS_DEFAULT_REGION = 'us-east-1'  // Adjust to your desired region

        // Use the Terraform version installed on the Jenkins agent
        TF_VERSION = '1.5.5'
    }

    stages {
        stage('Clone GitHub Repository') {
            steps {
                // Check out the repository containing the Terraform configuration
                git url: 'https://github.com/your-username/your-terraform-repo.git', branch: 'main'
            }
        }

        stage('Install Terraform') {
            steps {
                // Optionally ensure Terraform is installed on the agent
                sh '''
                if ! terraform --version | grep ${TF_VERSION}; then
                    curl -o terraform.zip https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
                    unzip terraform.zip && sudo mv terraform /usr/local/bin/
                fi
                terraform --version
                '''
            }
        }

        stage('Terraform Init') {
            steps {
                // Initialize Terraform to download providers and modules
                sh 'terraform init'
            }
        }

        stage('Terraform Plan') {
            steps {
                // Run Terraform plan to see what changes will be made
                sh 'terraform plan -out=tfplan'
            }
        }

        stage('Terraform Apply') {
            steps {
                // Apply the Terraform plan and create the instance
                sh 'terraform apply -auto-approve tfplan'
            }
        }
    }

    post {
        always {
            // Clean up after the pipeline finishes
            cleanWs()
        }

        success {
            echo 'Terraform apply successful. EC2 instance is running.'
        }

        failure {
            echo 'Terraform apply failed.'
        }
    }
}

